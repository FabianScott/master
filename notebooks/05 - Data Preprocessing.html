
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lecture 5. Data preprocessing &#8212; ML Engineering</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/05 - Data Preprocessing';</script>
    <link rel="icon" href="../_static/favicon.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lecture 6. Neural Networks" href="06%20-%20Neural%20Networks.html" />
    <link rel="prev" title="Lecture 4. Ensemble Learning" href="04%20-%20Ensemble%20Learning.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/banner.jpeg" class="logo__image only-light" alt="ML Engineering - Home"/>
    <img src="../_static/banner.jpeg" class="logo__image only-dark pst-js-only" alt="ML Engineering - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%200%20-%20Prerequisites.html">Prerequisites</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01%20-%20Introduction.html">Lecture 1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="02%20-%20Linear%20Models.html">Lecture 2. Linear models</a></li>

<li class="toctree-l1"><a class="reference internal" href="03%20-%20Model%20Evaluation.html">Lecture 3. Model Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="04%20-%20Ensemble%20Learning.html">Lecture 4. Ensemble Learning</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lecture 5. Data preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="06%20-%20Neural%20Networks.html">Lecture 6. Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="07%20-%20Convolutional%20Neural%20Networks.html">Lecture 7: Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="08%20-%20Transformers.html">Lecture 8. Neural Networks for text</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%201a%20-%20Linear%20Models%20for%20Regression.html">Lab 1a: Linear regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%201b%20-%20Linear%20Models%20for%20Classification.html">Lab 1b: Linear classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%203a%20-%20Ensembles.html">Lab 3: Ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%203b%20-%20Pipelines.html">Lab 4:  Data preprocessing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Tutorial%201%20-%20Python.html">Python for data analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial%202%20-%20Python%20for%20Data%20Analysis.html">Python for scientific computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tutorial%203%20-%20Machine%20Learning%20in%20Python.html">Machine Learning in Python</a></li>


<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%201%20-%20Tutorial.html">Lab 1: Machine Learning with Python</a></li>



<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%202%20-%20Tutorial.html">Lab 2: Model Selection in scikit-learn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../labs/Lab%203%20-%20Tutorial.html">Lab 4: Data engineering pipelines with scikit-learn</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/ml-course/master/blob/master/notebooks/05 - Data Preprocessing.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ml-course/master" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ml-course/master/issues/new?title=Issue%20on%20page%20%2Fnotebooks/05 - Data Preprocessing.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/05 - Data Preprocessing.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 5. Data preprocessing</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-transformations">Data transformations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scaling">Scaling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#power-transformations">Power transformations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#categorical-feature-encoding">Categorical feature encoding</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ordinal-encoding">Ordinal encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-dummy-encoding">One-hot encoding (dummy encoding)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#target-encoding">Target encoding</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-category-encoders">Example (category_encoders)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-practice-scikit-learn">In practice (scikit-learn)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-data-transformations">Applying data transformations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-set-distortion">Test set distortion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-leakage">Data leakage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-processing-pipelines">Data processing pipelines</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">In practice (scikit-learn)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-feature-selection">Automatic Feature Selection</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-bike-sharing">Example: bike sharing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-selection-overview">Feature selection: overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-based-feature-selection">Model-based Feature Selection</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#relief-model-based-selection-with-knn">Relief: Model-based selection with kNN</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-model-based-feature-selection">Iterative Model-based Feature Selection</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-feature-selection-wrapping">Sequential feature selection (Wrapping)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#permutation-feature-importance">Permutation feature importance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison">Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">In practice (scikit-learn)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-value-imputation">Missing value imputation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-imputation">Mean imputation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#knn-imputation">kNN imputation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-model-based-imputation">Iterative (model-based) Imputation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matrix-factorization">Matrix Factorization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#soft-thresholded-singular-value-decomposition-svd">Soft-thresholded Singular Value Decomposition (SVD)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">In practice (scikit-learn)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-practice-fancyimpute">In practice (fancyimpute)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-imbalanced-data">Handling imbalanced data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-undersampling">Random Undersampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-based-undersampling">Model-based Undersampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-oversampling">Random Oversampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-minority-oversampling-technique-smote">Synthetic Minority Oversampling Technique (SMOTE)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combined-techniques">Combined techniques</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-resampling">Ensemble Resampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-practice-imblearn">In practice (imblearn)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#real-world-data">Real-world data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-5-data-preprocessing">
<h1>Lecture 5. Data preprocessing<a class="headerlink" href="#lecture-5-data-preprocessing" title="Link to this heading">#</a></h1>
<p><strong>Real-world machine learning pipelines</strong></p>
<p>Joaquin Vanschoren</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Auto-setup when running on Google Colab</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="k">if</span> <span class="s1">&#39;google.colab&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/content/master&#39;</span><span class="p">):</span>
    <span class="o">!</span>git<span class="w"> </span>clone<span class="w"> </span>-q<span class="w"> </span>https://github.com/ML-course/master.git<span class="w"> </span>/content/master
    <span class="o">!</span>pip<span class="w"> </span>--quiet<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>/content/master/requirements_colab.txt
    <span class="o">%</span><span class="k">cd</span> master/notebooks

<span class="c1"># Global imports and settings</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span><span class="w"> </span><span class="nn">preamble</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">interactive</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Set to True for interactive plots</span>
<span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">fig_scale</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">print_config</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span> <span class="c1"># For printing</span>
    <span class="n">fig_scale</span> <span class="o">=</span> <span class="mf">0.35</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">print_config</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="data-transformations">
<h2>Data transformations<a class="headerlink" href="#data-transformations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Machine learning models make a lot of assumptions about the data</p></li>
<li><p>In reality, these assumptions are often violated</p></li>
<li><p>We build <em>pipelines</em> that <em>transform</em> the data before feeding it to the learners</p>
<ul>
<li><p>Scaling (or other numeric transformations)</p></li>
<li><p>Encoding (convert categorical features into numerical ones)</p></li>
<li><p>Automatic feature selection</p></li>
<li><p>Feature engineering (e.g. binning, polynomial features,…)</p></li>
<li><p>Handling missing data</p></li>
<li><p>Handling imbalanced data</p></li>
<li><p>Dimensionality reduction (e.g. PCA)</p></li>
<li><p>Learned embeddings (e.g. for text)</p></li>
</ul>
</li>
<li><p>Seek the best combinations of transformations and learning methods</p>
<ul>
<li><p>Often done empirically, using cross-validation</p></li>
<li><p>Make sure that there is no data leakage during this process!</p></li>
</ul>
</li>
</ul>
</section>
<section id="scaling">
<h2>Scaling<a class="headerlink" href="#scaling" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Use when different numeric features have different scales (different range of values)</p>
<ul>
<li><p>Features with much higher values may overpower the others</p></li>
</ul>
</li>
<li><p>Method based on distances (e.g. kNN, SVMs) will over-emphasize those features</p></li>
<li><p>Parametric models (e.g. linear models, neural nets) become hard to train (sensitive weights)</p></li>
<li><p>Goal: bring them all within the same range</p></li>
<li><p>Different methods exist (see the recap for details)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">RobustScaler</span><span class="p">,</span> <span class="n">Normalizer</span><span class="p">,</span> <span class="n">MaxAbsScaler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">widgets</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interact_manual</span>

<span class="c1"># Iris dataset with some added noise</span>
<span class="k">def</span><span class="w"> </span><span class="nf">noisy_iris</span><span class="p">():</span>
    <span class="n">iris</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span> <span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span>
    <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span> <span class="c1"># add more skew </span>
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="n">scalers</span> <span class="o">=</span> <span class="p">[</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">RobustScaler</span><span class="p">(),</span> <span class="n">MinMaxScaler</span><span class="p">(),</span> <span class="n">Normalizer</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">),</span> <span class="n">MaxAbsScaler</span><span class="p">()]</span>

<span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_scaling</span><span class="p">(</span><span class="n">scaler</span><span class="o">=</span><span class="n">scalers</span><span class="p">):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">noisy_iris</span><span class="p">()</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># Use only first 2 features</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;brg&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Data&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;zero&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;zero&#39;</span><span class="p">)</span>
    
    <span class="n">X_</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;brg&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">scaler</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "95746fa35b3b4a469de4913ce3992849", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_scaling</span><span class="p">(</span><span class="n">scalers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="power-transformations">
<h3>Power transformations<a class="headerlink" href="#power-transformations" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Some features follow certain distributions</p>
<ul>
<li><p>E.g. number of Instagram followers is log-normal distributed</p></li>
<li><p>Yet most ML methods assume normally-distributed data</p></li>
</ul>
</li>
<li><p>Box-Cox transformations transform these to normal distributions (<span class="math notranslate nohighlight">\(\lambda\)</span> is fitted)</p>
<ul>
<li><p>Only works for positive values, use Yeo-Johnson otherwise
$<span class="math notranslate nohighlight">\(bc_{\lambda}(x) = \begin{cases} log(x) &amp; \lambda = 0\\ \frac{x^{\lambda}-1}{\lambda} &amp; \lambda \neq 0 \\ \end{cases}\)</span>$</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adapted from an example by Eric Chang and Nicolas Hug </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PowerTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="c1"># Power transformer with Box-Cox</span>
<span class="n">bc</span> <span class="o">=</span> <span class="n">PowerTransformer</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;box-cox&#39;</span><span class="p">)</span>

<span class="c1"># Generate data</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span> <span class="c1"># Random number generator</span>
<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">X_lognormal</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># lognormal distribution</span>
<span class="n">X_chisq</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">chisquare</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># chi-squared distribution</span>
<span class="n">X_weibull</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">weibull</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># weibull distribution</span>

<span class="c1"># create plots</span>
<span class="n">distributions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Lognormal&#39;</span><span class="p">,</span> <span class="n">X_lognormal</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Chi-squared&#39;</span><span class="p">,</span> <span class="n">X_chisq</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Weibull&#39;</span><span class="p">,</span> <span class="n">X_weibull</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#D81B60&#39;</span><span class="p">,</span> <span class="s1">&#39;#0188FF&#39;</span><span class="p">,</span> <span class="s1">&#39;#FFC107&#39;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span><span class="mf">2.8</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">axes_idxs</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
<span class="n">axes_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">axes_idxs</span><span class="p">]</span>

<span class="k">for</span> <span class="n">distribution</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">axes</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">distributions</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">axes_list</span><span class="p">):</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">distribution</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

    <span class="c1"># perform power transforms and quantile transform</span>
    <span class="n">X_trans_bc</span> <span class="o">=</span> <span class="n">bc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">lmbda_bc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">bc</span><span class="o">.</span><span class="n">lambdas_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">ax_original</span><span class="p">,</span> <span class="n">ax_bc</span> <span class="o">=</span> <span class="n">axes</span>
    <span class="n">ax_original</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">ax_original</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">ax_original</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span>

    <span class="n">ax_bc</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">X_trans_bc</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;After </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Box-Cox&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lmbda_bc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="sa">r</span><span class="s1">&#39; $\lambda$ = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmbda_bc</span><span class="p">)</span>
    <span class="n">ax_bc</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">ax_bc</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">)</span>
    <span class="n">ax_bc</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>


<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/66e08b11a88c8ff24779e155a219cd0f052a913d439c1469c5ebb30e5b3fc201.png" src="../_images/66e08b11a88c8ff24779e155a219cd0f052a913d439c1469c5ebb30e5b3fc201.png" />
</div>
</div>
</section>
</section>
<section id="categorical-feature-encoding">
<h2>Categorical feature encoding<a class="headerlink" href="#categorical-feature-encoding" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Many algorithms can only handle numeric features, so we need to encode the categorical ones</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table_font_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">heading_properties</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="n">table_font_size</span><span class="p">)]</span>
<span class="n">cell_properties</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;font-size&#39;</span><span class="p">,</span> <span class="n">table_font_size</span><span class="p">)]</span>
<span class="n">dfstyle</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">heading_properties</span><span class="p">),</span>\
 <span class="nb">dict</span><span class="p">(</span><span class="n">selector</span><span class="o">=</span><span class="s2">&quot;td&quot;</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">cell_properties</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%HTML</span>
<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="nt">td</span><span class="w"> </span><span class="p">{</span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">}</span>
<span class="nt">th</span><span class="w"> </span><span class="p">{</span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">}</span>
<span class="p">.</span><span class="nc">rendered_html</span><span class="w"> </span><span class="nt">table</span><span class="o">,</span><span class="w"> </span><span class="p">.</span><span class="nc">rendered_html</span><span class="w"> </span><span class="nt">td</span><span class="o">,</span><span class="w"> </span><span class="p">.</span><span class="nc">rendered_html</span><span class="w"> </span><span class="nt">th</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">font-size</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
td {font-size: 10px}
th {font-size: 10px}
.rendered_html table, .rendered_html td, .rendered_html th {
    font-size: 20px;
}
</style>
</div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;boro&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Manhattan&#39;</span><span class="p">,</span> <span class="s1">&#39;Queens&#39;</span><span class="p">,</span> <span class="s1">&#39;Manhattan&#39;</span><span class="p">,</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">,</span> <span class="s1">&#39;Brooklyn&#39;</span><span class="p">,</span> <span class="s1">&#39;Bronx&#39;</span><span class="p">],</span>
                   <span class="s1">&#39;salary&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">103</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">219</span><span class="p">]})</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;vegan&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]})</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;vegan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_08bc4 th {
  font-size: 20;
}
#T_08bc4 td {
  font-size: 20;
}
</style>
<table id="T_08bc4">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_08bc4_level0_col0" class="col_heading level0 col0" >boro</th>
      <th id="T_08bc4_level0_col1" class="col_heading level0 col1" >salary</th>
      <th id="T_08bc4_level0_col2" class="col_heading level0 col2" >vegan</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_08bc4_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_08bc4_row0_col0" class="data row0 col0" >Manhattan</td>
      <td id="T_08bc4_row0_col1" class="data row0 col1" >103</td>
      <td id="T_08bc4_row0_col2" class="data row0 col2" >0</td>
    </tr>
    <tr>
      <th id="T_08bc4_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_08bc4_row1_col0" class="data row1 col0" >Queens</td>
      <td id="T_08bc4_row1_col1" class="data row1 col1" >89</td>
      <td id="T_08bc4_row1_col2" class="data row1 col2" >0</td>
    </tr>
    <tr>
      <th id="T_08bc4_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_08bc4_row2_col0" class="data row2 col0" >Manhattan</td>
      <td id="T_08bc4_row2_col1" class="data row2 col1" >142</td>
      <td id="T_08bc4_row2_col2" class="data row2 col2" >0</td>
    </tr>
    <tr>
      <th id="T_08bc4_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_08bc4_row3_col0" class="data row3 col0" >Brooklyn</td>
      <td id="T_08bc4_row3_col1" class="data row3 col1" >54</td>
      <td id="T_08bc4_row3_col2" class="data row3 col2" >1</td>
    </tr>
    <tr>
      <th id="T_08bc4_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_08bc4_row4_col0" class="data row4 col0" >Brooklyn</td>
      <td id="T_08bc4_row4_col1" class="data row4 col1" >63</td>
      <td id="T_08bc4_row4_col2" class="data row4 col2" >1</td>
    </tr>
    <tr>
      <th id="T_08bc4_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_08bc4_row5_col0" class="data row5 col0" >Bronx</td>
      <td id="T_08bc4_row5_col1" class="data row5 col1" >219</td>
      <td id="T_08bc4_row5_col2" class="data row5 col2" >0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<section id="ordinal-encoding">
<h3>Ordinal encoding<a class="headerlink" href="#ordinal-encoding" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Simply assigns an integer value to each category in the order they are encountered</p></li>
<li><p>Only really useful if there exist a natural order in categories</p>
<ul>
<li><p>Model will consider one category to be ‘higher’ or ‘closer’ to another</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrdinalEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Encode first feature, rest passthrough</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span>
<span class="n">X_ordinal</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Convert to pandas for nicer output</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_ordinal</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boro_ordinal&quot;</span><span class="p">,</span><span class="s2">&quot;salary&quot;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;boro&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_d169a th {
  font-size: 20;
}
#T_d169a td {
  font-size: 20;
}
</style>
<table id="T_d169a">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_d169a_level0_col0" class="col_heading level0 col0" >boro</th>
      <th id="T_d169a_level0_col1" class="col_heading level0 col1" >boro_ordinal</th>
      <th id="T_d169a_level0_col2" class="col_heading level0 col2" >salary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_d169a_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_d169a_row0_col0" class="data row0 col0" >Manhattan</td>
      <td id="T_d169a_row0_col1" class="data row0 col1" >2</td>
      <td id="T_d169a_row0_col2" class="data row0 col2" >103</td>
    </tr>
    <tr>
      <th id="T_d169a_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_d169a_row1_col0" class="data row1 col0" >Queens</td>
      <td id="T_d169a_row1_col1" class="data row1 col1" >3</td>
      <td id="T_d169a_row1_col2" class="data row1 col2" >89</td>
    </tr>
    <tr>
      <th id="T_d169a_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_d169a_row2_col0" class="data row2 col0" >Manhattan</td>
      <td id="T_d169a_row2_col1" class="data row2 col1" >2</td>
      <td id="T_d169a_row2_col2" class="data row2 col2" >142</td>
    </tr>
    <tr>
      <th id="T_d169a_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_d169a_row3_col0" class="data row3 col0" >Brooklyn</td>
      <td id="T_d169a_row3_col1" class="data row3 col1" >1</td>
      <td id="T_d169a_row3_col2" class="data row3 col2" >54</td>
    </tr>
    <tr>
      <th id="T_d169a_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_d169a_row4_col0" class="data row4 col0" >Brooklyn</td>
      <td id="T_d169a_row4_col1" class="data row4 col1" >1</td>
      <td id="T_d169a_row4_col2" class="data row4 col2" >63</td>
    </tr>
    <tr>
      <th id="T_d169a_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_d169a_row5_col0" class="data row5 col0" >Bronx</td>
      <td id="T_d169a_row5_col1" class="data row5 col1" >0</td>
      <td id="T_d169a_row5_col2" class="data row5 col2" >219</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="one-hot-encoding-dummy-encoding">
<h3>One-hot encoding (dummy encoding)<a class="headerlink" href="#one-hot-encoding-dummy-encoding" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Simply adds a new 0/1 feature for every category, having 1 (hot) if the sample has that category</p></li>
<li><p>Can explode if a feature has lots of values, causing issues with high dimensionality</p></li>
<li><p>What if test set contains a new category not seen in training data?</p>
<ul>
<li><p>Either ignore it (just use all 0’s in row), or handle manually (e.g. resample)</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Encode first feature, rest passthrough</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span>
<span class="n">X_ordinal</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Convert to pandas for nicer output</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">X_ordinal</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boro_Bronx&quot;</span><span class="p">,</span><span class="s2">&quot;boro_Brooklyn&quot;</span><span class="p">,</span><span class="s2">&quot;boro_Manhattan&quot;</span><span class="p">,</span><span class="s2">&quot;boro_Queens&quot;</span><span class="p">,</span><span class="s2">&quot;salary&quot;</span><span class="p">])</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;boro&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_2a15b th {
  font-size: 20;
}
#T_2a15b td {
  font-size: 20;
}
</style>
<table id="T_2a15b">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_2a15b_level0_col0" class="col_heading level0 col0" >boro</th>
      <th id="T_2a15b_level0_col1" class="col_heading level0 col1" >boro_Bronx</th>
      <th id="T_2a15b_level0_col2" class="col_heading level0 col2" >boro_Brooklyn</th>
      <th id="T_2a15b_level0_col3" class="col_heading level0 col3" >boro_Manhattan</th>
      <th id="T_2a15b_level0_col4" class="col_heading level0 col4" >boro_Queens</th>
      <th id="T_2a15b_level0_col5" class="col_heading level0 col5" >salary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_2a15b_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_2a15b_row0_col0" class="data row0 col0" >Manhattan</td>
      <td id="T_2a15b_row0_col1" class="data row0 col1" >0</td>
      <td id="T_2a15b_row0_col2" class="data row0 col2" >0</td>
      <td id="T_2a15b_row0_col3" class="data row0 col3" >1</td>
      <td id="T_2a15b_row0_col4" class="data row0 col4" >0</td>
      <td id="T_2a15b_row0_col5" class="data row0 col5" >103</td>
    </tr>
    <tr>
      <th id="T_2a15b_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_2a15b_row1_col0" class="data row1 col0" >Queens</td>
      <td id="T_2a15b_row1_col1" class="data row1 col1" >0</td>
      <td id="T_2a15b_row1_col2" class="data row1 col2" >0</td>
      <td id="T_2a15b_row1_col3" class="data row1 col3" >0</td>
      <td id="T_2a15b_row1_col4" class="data row1 col4" >1</td>
      <td id="T_2a15b_row1_col5" class="data row1 col5" >89</td>
    </tr>
    <tr>
      <th id="T_2a15b_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_2a15b_row2_col0" class="data row2 col0" >Manhattan</td>
      <td id="T_2a15b_row2_col1" class="data row2 col1" >0</td>
      <td id="T_2a15b_row2_col2" class="data row2 col2" >0</td>
      <td id="T_2a15b_row2_col3" class="data row2 col3" >1</td>
      <td id="T_2a15b_row2_col4" class="data row2 col4" >0</td>
      <td id="T_2a15b_row2_col5" class="data row2 col5" >142</td>
    </tr>
    <tr>
      <th id="T_2a15b_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_2a15b_row3_col0" class="data row3 col0" >Brooklyn</td>
      <td id="T_2a15b_row3_col1" class="data row3 col1" >0</td>
      <td id="T_2a15b_row3_col2" class="data row3 col2" >1</td>
      <td id="T_2a15b_row3_col3" class="data row3 col3" >0</td>
      <td id="T_2a15b_row3_col4" class="data row3 col4" >0</td>
      <td id="T_2a15b_row3_col5" class="data row3 col5" >54</td>
    </tr>
    <tr>
      <th id="T_2a15b_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_2a15b_row4_col0" class="data row4 col0" >Brooklyn</td>
      <td id="T_2a15b_row4_col1" class="data row4 col1" >0</td>
      <td id="T_2a15b_row4_col2" class="data row4 col2" >1</td>
      <td id="T_2a15b_row4_col3" class="data row4 col3" >0</td>
      <td id="T_2a15b_row4_col4" class="data row4 col4" >0</td>
      <td id="T_2a15b_row4_col5" class="data row4 col5" >63</td>
    </tr>
    <tr>
      <th id="T_2a15b_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_2a15b_row5_col0" class="data row5 col0" >Bronx</td>
      <td id="T_2a15b_row5_col1" class="data row5 col1" >1</td>
      <td id="T_2a15b_row5_col2" class="data row5 col2" >0</td>
      <td id="T_2a15b_row5_col3" class="data row5 col3" >0</td>
      <td id="T_2a15b_row5_col4" class="data row5 col4" >0</td>
      <td id="T_2a15b_row5_col5" class="data row5 col5" >219</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="target-encoding">
<h3>Target encoding<a class="headerlink" href="#target-encoding" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Value close to 1 if category correlates with class 1, close to 0 if correlates with class 0</p></li>
<li><p>Preferred when you have lots of category values. It only creates one new feature per class</p></li>
<li><p>Blends posterior probability of the target <span class="math notranslate nohighlight">\(\frac{n_{iY}}{n_i}\)</span> and prior probability <span class="math notranslate nohighlight">\(\frac{n_Y}{n}\)</span>.</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(n_{iY}\)</span>: nr of samples with category i and class Y=1, <span class="math notranslate nohighlight">\(n_{i}\)</span>: nr of samples with category i</p></li>
<li><p>Blending: gradually decrease as you get more examples of category i and class Y=0
$<span class="math notranslate nohighlight">\(Enc(i) = \color{blue}{\frac{1}{1+e^{-(n_{i}-1)}} \frac{n_{iY}}{n_i}} + \color{green}{(1-\frac{1}{1+e^{-(n_{i}-1)}}) \frac{n_Y}{n}}\)</span>$</p></li>
<li><p>Same for regression, using <span class="math notranslate nohighlight">\(\frac{n_{iY}}{n_i}\)</span>: average target value with category i, <span class="math notranslate nohighlight">\(\frac{n_{Y}}{n}\)</span>: overall mean</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># smoothed sigmoid</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">smoothing</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_blend</span><span class="p">():</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># 20 points</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># 10 points of class Yes</span>
    <span class="n">niy</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># number of points of category i and class Yes</span>
    <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">niy</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> <span class="c1">#  10 points of category i</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span><span class="mf">1.8</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">niy</span><span class="o">/</span><span class="n">ni</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;posterior term&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ni</span><span class="p">,(</span><span class="mi">1</span><span class="o">-</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="n">n</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;prior term&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ni</span><span class="p">,</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">niy</span><span class="o">/</span><span class="n">ni</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">ni</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">/</span><span class="n">n</span><span class="p">),</span><span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;blend&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$n_</span><span class="si">{i}</span><span class="s2">$ ($n_</span><span class="si">{iY}</span><span class="s2"> = 2$)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Encoding for Y=1&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">plot_blend</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/a7475e6a6e2206048d7f91ff926a58ccc5f407441dd7030ace2dedf38b6daa79.png" src="../_images/a7475e6a6e2206048d7f91ff926a58ccc5f407441dd7030ace2dedf38b6daa79.png" />
</div>
</div>
<section id="example-category-encoders">
<h4>Example (category_encoders)<a class="headerlink" href="#example-category-encoders" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>For Brooklyn, <span class="math notranslate nohighlight">\(n_{iY}=2, n_{i}=2, n_{Y}=2, n=6\)</span></p></li>
<li><p>Would be closer to 1 if there were more examples, all with label 1
$<span class="math notranslate nohighlight">\(Enc(Brooklyn) = \frac{1}{1+e^{-1}} \frac{2}{2} + (1-\frac{1}{1+e^{-1}}) \frac{2}{6}  = 0,82\)</span>$</p></li>
<li><p>Note: the implementation used here sets <span class="math notranslate nohighlight">\(Enc(i)=\frac{n_Y}{n}\)</span> when <span class="math notranslate nohighlight">\(n_{iY}=1\)</span></p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Not in sklearn yet, use package category_encoders</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">category_encoders</span><span class="w"> </span><span class="kn">import</span> <span class="n">TargetEncoder</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">TargetEncoder</span><span class="p">(</span><span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">pd_te</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Convert to pandas for nicer output</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pd_te</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;boro&quot;</span><span class="p">,</span><span class="s2">&quot;salary&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;boro&#39;</span><span class="p">:</span> <span class="s1">&#39;boro_encoded&#39;</span><span class="p">})</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="s1">&#39;boro&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">dfstyle</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><style type="text/css">
#T_1c3b7 th {
  font-size: 20;
}
#T_1c3b7 td {
  font-size: 20;
}
</style>
<table id="T_1c3b7">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_1c3b7_level0_col0" class="col_heading level0 col0" >boro</th>
      <th id="T_1c3b7_level0_col1" class="col_heading level0 col1" >boro_encoded</th>
      <th id="T_1c3b7_level0_col2" class="col_heading level0 col2" >salary</th>
      <th id="T_1c3b7_level0_col3" class="col_heading level0 col3" >vegan</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_1c3b7_level0_row0" class="row_heading level0 row0" >0</th>
      <td id="T_1c3b7_row0_col0" class="data row0 col0" >Manhattan</td>
      <td id="T_1c3b7_row0_col1" class="data row0 col1" >0.089647</td>
      <td id="T_1c3b7_row0_col2" class="data row0 col2" >103</td>
      <td id="T_1c3b7_row0_col3" class="data row0 col3" >0</td>
    </tr>
    <tr>
      <th id="T_1c3b7_level0_row1" class="row_heading level0 row1" >1</th>
      <td id="T_1c3b7_row1_col0" class="data row1 col0" >Queens</td>
      <td id="T_1c3b7_row1_col1" class="data row1 col1" >0.166667</td>
      <td id="T_1c3b7_row1_col2" class="data row1 col2" >89</td>
      <td id="T_1c3b7_row1_col3" class="data row1 col3" >0</td>
    </tr>
    <tr>
      <th id="T_1c3b7_level0_row2" class="row_heading level0 row2" >2</th>
      <td id="T_1c3b7_row2_col0" class="data row2 col0" >Manhattan</td>
      <td id="T_1c3b7_row2_col1" class="data row2 col1" >0.089647</td>
      <td id="T_1c3b7_row2_col2" class="data row2 col2" >142</td>
      <td id="T_1c3b7_row2_col3" class="data row2 col3" >0</td>
    </tr>
    <tr>
      <th id="T_1c3b7_level0_row3" class="row_heading level0 row3" >3</th>
      <td id="T_1c3b7_row3_col0" class="data row3 col0" >Brooklyn</td>
      <td id="T_1c3b7_row3_col1" class="data row3 col1" >0.820706</td>
      <td id="T_1c3b7_row3_col2" class="data row3 col2" >54</td>
      <td id="T_1c3b7_row3_col3" class="data row3 col3" >1</td>
    </tr>
    <tr>
      <th id="T_1c3b7_level0_row4" class="row_heading level0 row4" >4</th>
      <td id="T_1c3b7_row4_col0" class="data row4 col0" >Brooklyn</td>
      <td id="T_1c3b7_row4_col1" class="data row4 col1" >0.820706</td>
      <td id="T_1c3b7_row4_col2" class="data row4 col2" >63</td>
      <td id="T_1c3b7_row4_col3" class="data row4 col3" >1</td>
    </tr>
    <tr>
      <th id="T_1c3b7_level0_row5" class="row_heading level0 row5" >5</th>
      <td id="T_1c3b7_row5_col0" class="data row5 col0" >Bronx</td>
      <td id="T_1c3b7_row5_col1" class="data row5 col1" >0.166667</td>
      <td id="T_1c3b7_row5_col2" class="data row5 col2" >219</td>
      <td id="T_1c3b7_row5_col3" class="data row5 col3" >0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
</section>
<section id="in-practice-scikit-learn">
<h3>In practice (scikit-learn)<a class="headerlink" href="#in-practice-scikit-learn" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Ordinal encoding, one-hot encoding, target encoding are implemented in scikit-learn</p>
<ul>
<li><p>dtype defines that the output should be an integer</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ordinal_encoder</span> <span class="o">=</span> <span class="n">OrdinalEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">one_hot_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">target_encoder</span> <span class="o">=</span> <span class="n">TargetEncoder</span><span class="p">(</span><span class="n">smooth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Target encoding is available in <code class="docutils literal notranslate"><span class="pre">category_encoders</span></code></p>
<ul>
<li><p>scikit-learn compatible</p></li>
<li><p>Also includes other, very specific encoders</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">target_encoder</span> <span class="o">=</span> <span class="n">TargetEncoder</span><span class="p">(</span><span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>All encoders (and scalers) follow the <code class="docutils literal notranslate"><span class="pre">fit-transform</span></code> paradigm</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">fit</span></code> prepares the encoder, <code class="docutils literal notranslate"><span class="pre">transform</span></code> actually encodes the features</p></li>
<li><p>We’ll discuss this next</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">encoder</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">X_encoded</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="applying-data-transformations">
<h2>Applying data transformations<a class="headerlink" href="#applying-data-transformations" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Data transformations should always follow a <code class="docutils literal notranslate"><span class="pre">fit-predict</span></code> paradigm</p>
<ul>
<li><p>‘Fit’ (train) the transformer on the <strong>training data</strong> only</p>
<ul>
<li><p>E.g. for a standard scaler: record the mean and standard deviation</p></li>
</ul>
</li>
<li><p>Transform (e.g. scale) the <strong>training data</strong>, then train the learning model</p></li>
<li><p>Transform (e.g. scale) the <strong>test data</strong>, then evaluate the model</p></li>
</ul>
</li>
<li><p>Only scale the input features (X), not the targets (y)!</p></li>
<li><p>If you fit and transform the whole dataset before splitting, you get <strong>data leakage</strong></p>
<ul>
<li><p>You have looked at the test data before training the model</p></li>
</ul>
</li>
<li><p>If you fit and transform the training and test data separately, you <strong>distort the test set</strong></p>
<ul>
<li><p>E.g. training and test points are scaled differently</p></li>
</ul>
</li>
<li><p>In both cases, model evaluations will be misleading or meaningless</p></li>
</ul>
<section id="test-set-distortion">
<h3>Test set distortion<a class="headerlink" href="#test-set-distortion" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Properly scaled: <code class="docutils literal notranslate"><span class="pre">fit</span></code> on training set, <code class="docutils literal notranslate"><span class="pre">transform</span></code> on training and test set</p></li>
<li><p>Improperly scaled: <code class="docutils literal notranslate"><span class="pre">fit</span></code> and <code class="docutils literal notranslate"><span class="pre">transform</span></code> on the training and test data separately</p>
<ul>
<li><p>Test data points nowhere near same training data points</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.axes._axes</span><span class="w"> </span><span class="kn">import</span> <span class="n">_log</span> <span class="k">as</span> <span class="n">matplotlib_axes_logger</span>
<span class="n">matplotlib_axes_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_blobs</span>
<span class="c1"># make synthetic data</span>
<span class="n">X</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_blobs</span><span class="p">(</span><span class="n">n_samples</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">centers</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cluster_std</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># split it into training and test set</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>

<span class="c1"># plot the training and test set</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Data&quot;</span><span class="p">)</span>

<span class="c1"># scale the data using MinMaxScaler</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># visualize the properly scaled data</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Training set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Scaled Data&quot;</span><span class="p">)</span>

<span class="c1"># rescale the test set separately</span>
<span class="c1"># so that test set min is 0 and test set max is 1</span>
<span class="c1"># DO NOT DO THIS! For illustration purposes only</span>
<span class="n">test_scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">test_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">X_test_scaled_badly</span> <span class="o">=</span> <span class="n">test_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># visualize wrongly scaled data</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_train_scaled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;training set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_test_scaled_badly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_test_scaled_badly</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">mglearn</span><span class="o">.</span><span class="n">cm2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;test set&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Improperly Scaled Data&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Feature 0&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Feature 1&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/2c117418cb0e3da73c68b2bcb85285f775304ec06eafadde547e5e9840a3d04a.png" src="../_images/2c117418cb0e3da73c68b2bcb85285f775304ec06eafadde547e5e9840a3d04a.png" />
</div>
</div>
</section>
<section id="data-leakage">
<h3>Data leakage<a class="headerlink" href="#data-leakage" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Cross-validation: training set is split into training and validation sets for model selection</p></li>
<li><p>Incorrect: Scaler is fit on whole training set before doing cross-validation</p>
<ul>
<li><p>Data leaks from validation folds into training folds, selected model may be optimistic</p></li>
</ul>
</li>
<li><p>Right: Scaler is fit on training folds only</p></li>
</ul>
<img src="https://raw.githubusercontent.com/ML-course/master/master/notebooks/images/infoleak.png" alt="ml" style="width: 1500px;"/></section>
<section id="data-processing-pipelines">
<h3>Data processing pipelines<a class="headerlink" href="#data-processing-pipelines" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Many ML libraries have ways to build ‘pipelines’ of data transformations and learners</p>
<ul>
<li><p>Ensures that data transformations are applied correctly</p></li>
</ul>
</li>
<li><p>E.g. scikit-learn pipelines have a <code class="docutils literal notranslate"><span class="pre">fit</span></code>, <code class="docutils literal notranslate"><span class="pre">predict</span></code>, and <code class="docutils literal notranslate"><span class="pre">score</span></code> method</p>
<ul>
<li><p>Internally applies transformations correctly</p></li>
</ul>
</li>
<li><p>If not, ensure that no data leakage happens!</p>
<ul>
<li><p>Data transformations should be independent from the test set</p></li>
</ul>
</li>
</ul>
<img src="https://raw.githubusercontent.com/ML-course/master/master/notebooks/images/07_pipelines.png" alt="ml" style="width: 600px;"/><section id="id1">
<h4>In practice (scikit-learn)<a class="headerlink" href="#id1" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">pipeline</span></code> combines multiple processing <em>steps</em> in a single estimator</p></li>
<li><p>Can also be split, combined, tuned,…</p></li>
<li><p>See the lab tutorial for more in-depth examples</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make pipeline</span>
<span class="n">pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">MinMaxScaler</span><span class="p">(),</span> <span class="n">Ridge</span><span class="p">())</span>

<span class="c1"># Correct fit and score</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="c1"># Correct cross-validation</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># Correct tuning</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ridge__alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">]}</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="o">.</span><span class="n">best_params_</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="automatic-feature-selection">
<h2>Automatic Feature Selection<a class="headerlink" href="#automatic-feature-selection" title="Link to this heading">#</a></h2>
<p>It can be a good idea to reduce the number of features to only the most useful ones</p>
<ul class="simple">
<li><p>Simpler models that generalize better (less overfitting)</p>
<ul>
<li><p>Curse of dimensionality (e.g. kNN)</p></li>
<li><p>Even models such as RandomForest can benefit from this</p></li>
<li><p>Sometimes it is one of the main methods to improve models (e.g. gene expression data)</p></li>
</ul>
</li>
<li><p>Faster prediction and training</p>
<ul>
<li><p>Training time can be quadratic (or cubic) in number of features</p></li>
</ul>
</li>
<li><p>Easier data collection, smaller models (less storage)</p></li>
<li><p>More interpretable models: fewer features to look at</p></li>
</ul>
<section id="example-bike-sharing">
<h3>Example: bike sharing<a class="headerlink" href="#example-bike-sharing" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The Bike Sharing Demand dataset shows the amount of bikes rented in Washington DC</p></li>
<li><p>Some features are clearly more informative than others (e.g. temp, hour)</p></li>
<li><p>Some are correlated (e.g. temp and feel_temp)</p></li>
<li><p>We add two random features at the end</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="c1"># Get bike sharing data from OpenML</span>
<span class="n">bikes</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="n">data_id</span><span class="o">=</span><span class="mi">42713</span><span class="p">,</span> <span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_bike_cat</span><span class="p">,</span> <span class="n">y_bike</span> <span class="o">=</span> <span class="n">bikes</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bikes</span><span class="o">.</span><span class="n">target</span>

<span class="c1"># Optional: take half of the data to speed up processing</span>
<span class="n">X_bike_cat</span> <span class="o">=</span> <span class="n">X_bike_cat</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y_bike</span> <span class="o">=</span> <span class="n">y_bike</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># One-hot encode the categorical features</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span><span class="n">transformers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">])],</span> <span class="n">remainder</span><span class="o">=</span><span class="s1">&#39;passthrough&#39;</span><span class="p">)</span>
<span class="n">X_bike</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_bike_cat</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Add 2 random features at the end</span>
<span class="n">random_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
<span class="n">X_bike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span><span class="n">random_features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create feature names</span>
<span class="n">bike_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;summer&#39;</span><span class="p">,</span><span class="s1">&#39;winter&#39;</span><span class="p">,</span> <span class="s1">&#39;spring&#39;</span><span class="p">,</span> <span class="s1">&#39;fall&#39;</span><span class="p">,</span> <span class="s1">&#39;clear&#39;</span><span class="p">,</span> <span class="s1">&#39;misty&#39;</span><span class="p">,</span> <span class="s1">&#39;rain&#39;</span><span class="p">,</span> <span class="s1">&#39;heavy_rain&#39;</span><span class="p">]</span>
<span class="n">bike_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_bike_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">bike_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">X_bike_cat</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span>
<span class="n">bike_names</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;random_1&#39;</span><span class="p">,</span><span class="s1">&#39;random_2&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#pd.set_option(&#39;display.max_columns&#39;, 20)</span>
<span class="c1">#pd.DataFrame(data=X_bike, columns=bike_names).head()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_bike</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">y_bike</span><span class="p">[:],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bike_names</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/8260cd300e1a626bd911d51aeba61a289e45a39fd9db4912e467761fe5ab1bd1.png" src="../_images/8260cd300e1a626bd911d51aeba61a289e45a39fd9db4912e467761fe5ab1bd1.png" />
</div>
</div>
</section>
<section id="feature-selection-overview">
<h3>Feature selection: overview<a class="headerlink" href="#feature-selection-overview" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Basic techniques (see the data processing recap)</p>
<ul>
<li><p>Unsupervised selection (e.g., variance and covariance-based techniques)</p></li>
<li><p>Univariate statistics (e.g., F-test and Mutual Information)</p></li>
</ul>
</li>
<li><p>We’ll focus on the most powerful techniques:</p>
<ul>
<li><p>Model-based: Random Forests, Linear models, kNN</p></li>
<li><p>Wrapping techniques (black-box search)</p></li>
<li><p>Permutation importance</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">f_regression</span><span class="p">,</span> <span class="n">SelectPercentile</span><span class="p">,</span> <span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">SelectFromModel</span><span class="p">,</span> <span class="n">RFE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">scale</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">RidgeCV</span><span class="p">,</span> <span class="n">LassoCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlxtend.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequentialFeatureSelector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.inspection</span><span class="w"> </span><span class="kn">import</span> <span class="n">permutation_importance</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.notebook</span><span class="w"> </span><span class="kn">import</span> <span class="n">trange</span><span class="p">,</span> <span class="n">tqdm</span>

<span class="c1"># Pre-compute all importances on bike sharing dataset</span>
<span class="c1"># Scaled feature selection thresholds</span>
<span class="n">thresholds</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="c1"># Dict to store all data</span>
<span class="n">fs</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">,</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">,</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span><span class="s1">&#39;Ridge&#39;</span><span class="p">,</span><span class="s1">&#39;Lasso&#39;</span><span class="p">,</span><span class="s1">&#39;RFE&#39;</span><span class="p">,</span>
           <span class="s1">&#39;ForwardSelection&#39;</span><span class="p">,</span><span class="s1">&#39;FloatingForwardSelection&#39;</span><span class="p">,</span><span class="s1">&#39;Permutation&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span> <span class="c1">#RidgeCV() #RandomForestRegressor(n_estimators=100) </span>
    <span class="n">select_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">selector</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">select_pipe</span><span class="p">,</span> <span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Tuned RF (pre-computed to save time)</span>
<span class="c1"># param_grid = {&quot;max_features&quot;:[2,4,8,16],&quot;max_depth&quot;:[8,16,32,64,128]}</span>
<span class="c1"># randomforestCV = GridSearchCV(RandomForestRegressor(n_estimators=200),</span>
<span class="c1">#                              param_grid=param_grid).fit(X_bike, y_bike).best_estimator_</span>
<span class="n">randomforestCV</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">max_features</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="c1"># F test</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing F test&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;F test&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_regression</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span><span class="n">y_bike</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectPercentile</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">f_regression</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">t</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span> <span class="n">y_bike</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;FTest&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>

<span class="c1"># Mutual information</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Mutual information&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Mutual Information&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutual_info_regression</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span><span class="n">y_bike</span><span class="p">,</span><span class="n">discrete_features</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span> <span class="c1"># first 13 features are discrete</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectPercentile</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">mutual_info_regression</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">t</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span> <span class="n">y_bike</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;MutualInformation&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
    
<span class="c1"># Random Forest</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Random Forest&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Random Forest&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">randomforestCV</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">randomforestCV</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">*mean&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span> <span class="c1"># Threshold can&#39;t be easily scaled here</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
    
<span class="c1"># Ridge, Lasso</span>
<span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">RidgeCV</span><span class="p">(),</span><span class="n">LassoCV</span><span class="p">()]:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;CV&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span><span class="o">.</span><span class="n">coef_</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]))</span> <span class="c1"># Use absolute values</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">*mean&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">X_bike</span><span class="p">),</span> <span class="n">y_bike</span><span class="p">)</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        
<span class="c1"># Recursive Feature Elimination</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing RFE&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Recursive Feature Elimination (with RandomForest)&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span><span class="o">.</span><span class="n">ranking_</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span> <span class="o">-</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span><span class="o">/</span> <span class="mi">19</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">20</span><span class="p">))</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">support_</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;RFE&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>

<span class="c1"># Sequential Feature Selection</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Forward selection&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">floating</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">]:</span> <span class="c1"># Doing only non-floating to speed up computations</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">ForwardSelection&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Floating&quot;</span> <span class="k">if</span> <span class="n">floating</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (with Ridge)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="c1"># There is no scoring here</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">SequentialFeatureSelector</span><span class="p">(</span><span class="n">RidgeCV</span><span class="p">(),</span> <span class="n">k_features</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">20</span><span class="p">),</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">floating</span><span class="o">=</span><span class="n">floating</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">)</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">selector</span><span class="o">.</span><span class="n">k_feature_idx_</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
        <span class="n">fs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv_score</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
        
<span class="c1"># Permutation Importance  </span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing Permutation importance&quot;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Permutation importance (with RandomForest))&quot;</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">),</span> <span class="n">X_bike</span><span class="p">,</span> <span class="n">y_bike</span><span class="p">,</span> 
                                                    <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">importances_mean</span>
<span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span>
<span class="n">sorted_idx</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;score&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="c1"># inverted sort</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">thresholds</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">sorted_idx</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">*</span><span class="mi">20</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)])</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="c1"># Hard to use this in a pipeline, resorting to transforming the data beforehand</span>
    <span class="n">fs</span><span class="p">[</span><span class="s1">&#39;Permutation&#39;</span><span class="p">][</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cross_val_score</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">X_bike</span><span class="p">[:,</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_bike</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing F test
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a340f343c9a746679630212407b0acd8", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Mutual information
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "53cfc1824f124743a999f474d1f6d430", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Random Forest
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "132a320fc2ee43cfb1d57bbc020bfec0", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Ridge
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ade531f6192b4427b546dae6f3dde8d4", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Lasso
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f611609ec89b4ffe9c796d19a8e291c5", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing RFE
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7160e854548c4bb5a0ddf974850f6c37", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Forward selection
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "a4f5c5fde3754ada987377ebd3d9ad99", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Computing Permutation importance
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "dbc1feb3d936459886fcc47b920d5115", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="o">=</span><span class="s1">&#39;f_test&#39;</span><span class="p">,</span> <span class="n">method2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    
    <span class="c1"># Plot scores</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">1</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mf">0.3</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="n">method1</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">]</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">imp</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method2</span><span class="p">:</span>
        <span class="n">imp2</span> <span class="o">=</span> <span class="n">fs</span><span class="p">[</span><span class="n">method2</span><span class="p">]</span>
        <span class="n">mask2</span> <span class="o">=</span> <span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">]</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="n">mask2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">mask2</span><span class="p">]</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;scaled_score&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask2</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">],[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (Ridge R2:</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">]),</span>
                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (Ridge R2:</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">imp2</span><span class="p">[</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">])],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">m1</span><span class="p">],[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (Ridge R2:</span><span class="si">{:.2f}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span><span class="n">imp</span><span class="p">[</span><span class="s1">&#39;cv_score&#39;</span><span class="p">][</span><span class="n">threshold</span><span class="p">])],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bike_names</span><span class="p">)))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">bike_names</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feature importance (selection threshold </span><span class="si">{:.2f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
                        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">method2</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)):</span>
    <span class="n">plot_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span><span class="n">method2</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cf4991b2cabf4a0aba7d05efc3502393", "version_major": 2, "version_minor": 0}</script></div>
</div>
</section>
<section id="model-based-feature-selection">
<h3>Model-based Feature Selection<a class="headerlink" href="#model-based-feature-selection" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Use a <a class="reference external" href="https://explained.ai/rf-importance/index.html">tuned</a>(!) supervised model to judge the importance of each feature</p>
<ul>
<li><p>Linear models (Ridge, Lasso, LinearSVM,…): features with highest weights (coefficients)</p></li>
<li><p>Tree–based models: features used in first nodes (high information gain)</p></li>
</ul>
</li>
<li><p>Selection model can be different from the one you use for final modelling</p></li>
<li><p>Captures interactions: features are more/less informative in combination (e.g. winter, temp)</p></li>
<li><p>RandomForests: learns complex interactions (e.g. hour), but biased to high cardinality features</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span> <span class="s1">&#39;Lasso&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e1d35d493cb6c9ff9c55fe7719b9713c9d79be5a71b33cba4f089ef9c41e9d3b.png" src="../_images/e1d35d493cb6c9ff9c55fe7719b9713c9d79be5a71b33cba4f089ef9c41e9d3b.png" />
</div>
</div>
<section id="relief-model-based-selection-with-knn">
<h4>Relief: Model-based selection with kNN<a class="headerlink" href="#relief-model-based-selection-with-knn" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>For I iterations, choose a random point <span class="math notranslate nohighlight">\(\mathbf{x_i}\)</span> and find <span class="math notranslate nohighlight">\(k\)</span> nearest neighbors <span class="math notranslate nohighlight">\(\mathbf{x_{k}}\)</span></p></li>
<li><p>Increase feature weights if <span class="math notranslate nohighlight">\(\mathbf{x_i}\)</span> and <span class="math notranslate nohighlight">\(\mathbf{x_{k}}\)</span> have different class (near miss), else decrease</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(\mathbf{w_i} = \mathbf{w_{i-1}} + (\mathbf{x_i} - \text{nearMiss}_i)^2 - (\mathbf{x_i} - \text{nearHit}_i)^2\)</span></p></li>
</ul>
</li>
<li><p>Many variants: ReliefF (uses L1 norm, faster), RReliefF (for regression), …</p></li>
</ul>
<img src="https://raw.githubusercontent.com/ML-course/master/master/notebooks/images/relief.png" alt="ml" style="width: 40%;"/></section>
<section id="iterative-model-based-feature-selection">
<h4>Iterative Model-based Feature Selection<a class="headerlink" href="#iterative-model-based-feature-selection" title="Link to this heading">#</a></h4>
<ul class="simple">
<li><p>Dropping many features at once is not ideal: feature importance may change in subset</p></li>
<li><p>Recursive Feature Elimination (RFE)</p>
<ul>
<li><p>Remove <span class="math notranslate nohighlight">\(s\)</span> least important feature(s), recompute remaining importances, repeat</p></li>
</ul>
</li>
<li><p>Can be rather slow</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;RFE&#39;</span><span class="p">,</span> <span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/696e492abc030a132e3a4db06d1bf478196d92de97ae40cb4e3a0fd3278a01f4.png" src="../_images/696e492abc030a132e3a4db06d1bf478196d92de97ae40cb4e3a0fd3278a01f4.png" />
</div>
</div>
</section>
</section>
<section id="sequential-feature-selection-wrapping">
<h3>Sequential feature selection (Wrapping)<a class="headerlink" href="#sequential-feature-selection-wrapping" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Evaluate your model with different sets of features, find best subset based on performance</p></li>
<li><p>Greedy black-box search (can end up in local minima)</p>
<ul>
<li><p>Backward selection: remove least important feature, recompute importances, repeat</p></li>
<li><p>Forward selection: set aside most important feature, recompute importances, repeat</p></li>
<li><p>Floating: add best new feature, remove worst one, repeat (forward or backward)</p></li>
</ul>
</li>
<li><p>Stochastic search: use random mutations in candidate subset (e.g. simulated annealing)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;ForwardSelection&#39;</span><span class="p">,</span> <span class="s1">&#39;Ridge&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/59fa5b223696cd3b0802d996dc86a956e04ff69964b8181b780742b72208701e.png" src="../_images/59fa5b223696cd3b0802d996dc86a956e04ff69964b8181b780742b72208701e.png" />
</div>
</div>
</section>
<section id="permutation-feature-importance">
<h3>Permutation feature importance<a class="headerlink" href="#permutation-feature-importance" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Defined as the decrease in model performance when a single feature value is randomly shuffled</p>
<ul>
<li><p>This breaks the relationship between the feature and the target</p></li>
</ul>
</li>
<li><p>Model agnostic, metric agnostic, and can be calculated many times with different permutations</p></li>
<li><p>Can be applied to unseen data (not possible with model-based techniques)</p></li>
<li><p>Less biased towards high-cardinality features (compared with RandomForests)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;Permutation&#39;</span><span class="p">,</span> <span class="s1">&#39;RandomForest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/b8634eb7c76dc92491c75fe39c9b72cada934c3704aae158002da90a8b3b3f32.png" src="../_images/b8634eb7c76dc92491c75fe39c9b72cada934c3704aae158002da90a8b3b3f32.png" />
</div>
</div>
</section>
<section id="comparison">
<h3>Comparison<a class="headerlink" href="#comparison" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Feature importances (scaled) and cross-validated <span class="math notranslate nohighlight">\(R^2\)</span> score of pipeline</p>
<ul>
<li><p>Pipeline contains features selection + Ridge</p></li>
</ul>
</li>
<li><p>Selection threshold value ranges from 25% to 100% of all features</p></li>
<li><p>Best method ultimately depends on the problem and dataset at hand</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">method2</span><span class="o">=</span><span class="n">methods</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.25</span><span class="p">)):</span>
    <span class="n">plot_feature_importances</span><span class="p">(</span><span class="n">method1</span><span class="p">,</span><span class="n">method2</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "df324600010347d996e2e70b1292ffa6", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_feature_importances</span><span class="p">(</span><span class="s1">&#39;Permutation&#39;</span><span class="p">,</span> <span class="s1">&#39;FTest&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="id2">
<h3>In practice (scikit-learn)<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Unsupervised: <code class="docutils literal notranslate"><span class="pre">VarianceTreshold</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">VarianceThreshold</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">variances</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">variances_</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Univariate:</p>
<ul>
<li><p>For regression: <code class="docutils literal notranslate"><span class="pre">f_regression</span></code>, <code class="docutils literal notranslate"><span class="pre">mutual_info_regression</span></code></p></li>
<li><p>For classification: <code class="docutils literal notranslate"><span class="pre">f_classification</span></code>, <code class="docutils literal notranslate"><span class="pre">chi2</span></code>, <code class="docutils literal notranslate"><span class="pre">mutual_info_classication</span></code></p></li>
<li><p>Selecting: <code class="docutils literal notranslate"><span class="pre">SelectKBest</span></code>, <code class="docutils literal notranslate"><span class="pre">SelectPercentile</span></code>, <code class="docutils literal notranslate"><span class="pre">SelectFpr</span></code>,…</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SelectPercentile</span><span class="p">(</span><span class="n">score_func</span><span class="o">=</span><span class="n">f_regression</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()</span>
<span class="n">f_values</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">f_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">mi_values</span> <span class="o">=</span> <span class="n">mutual_info_regression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">discrete_features</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Model-based:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">SelectFromModel</span></code>: requires a model and a selection threshold</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RFE</span></code>, <code class="docutils literal notranslate"><span class="pre">RFECV</span></code> (recursive feature elimination): requires model and final nr features</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">(),</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
<span class="n">rfe_selector</span> <span class="o">=</span> <span class="n">RFE</span><span class="p">(</span><span class="n">RidgeCV</span><span class="p">(),</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">rf_importances</span> <span class="o">=</span> <span class="n">Randomforest</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">feature_importances_</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Sequential feature selection (from <code class="docutils literal notranslate"><span class="pre">mlxtend</span></code>, sklearn-compatible)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">SequentialFeatureSelector</span><span class="p">(</span><span class="n">RidgeCV</span><span class="p">(),</span> <span class="n">k_features</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                     <span class="n">floating</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Permutation Importance (in <code class="docutils literal notranslate"><span class="pre">sklearn.inspection</span></code>), no fit-transform interface</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">importances</span> <span class="o">=</span> <span class="n">permutation_importance</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> 
                                     <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">importances_mean</span>
<span class="n">feature_ids</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">importances</span><span class="p">)</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[:</span><span class="n">n</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="missing-value-imputation">
<h2>Missing value imputation<a class="headerlink" href="#missing-value-imputation" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Data can be missing in different ways:</p>
<ul>
<li><p>Missing Completely at Random (MCAR): purely random points are missing</p></li>
<li><p>Missing at Random (MAR): something affects missingness, but no relation with the value</p>
<ul>
<li><p>E.g. faulty sensors, some people don’t fill out forms correctly</p></li>
</ul>
</li>
<li><p>Missing Not At Random (MNAR): systematic missingness linked to the value</p>
<ul>
<li><p>Has to be modelled or resolved (e.g. sensor decay, sick people leaving study)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Missingness can be encoded in different ways:’?’, ‘-1’, ‘unknown’, ‘NA’,…</p></li>
<li><p>Also labels can be missing (remove example or use semi-supervised learning)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.experimental</span><span class="w"> </span><span class="kn">import</span> <span class="n">enable_iterative_imputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.impute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimpleImputer</span><span class="p">,</span> <span class="n">KNNImputer</span><span class="p">,</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">BayesianRidge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fancyimpute</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoftImpute</span><span class="p">,</span> <span class="n">IterativeSVD</span><span class="p">,</span> <span class="n">MatrixFactorization</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils._testing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ignore_warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConvergenceWarning</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlines</span>

<span class="c1"># Colors</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Normalize</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">norm</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">colors</span>

<span class="c1"># Iris dataset with some added noise and missing values</span>
<span class="k">def</span><span class="w"> </span><span class="nf">missing_iris</span><span class="p">():</span>
    <span class="n">iris</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_frame</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">iris</span>
    
    <span class="c1"># Make some noise</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">noise</span>
    
    <span class="c1"># Add missing data. Set smallest leaf measurements to NaN</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.6</span>
    <span class="n">X</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">.9</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">6.5</span>
    <span class="n">X</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
    
    <span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="c1"># List of my favorite imputers</span>
<span class="n">imputers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Mean Imputation&quot;</span><span class="p">:</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">),</span> 
            <span class="s2">&quot;kNN Imputation&quot;</span><span class="p">:</span> <span class="n">KNNImputer</span><span class="p">(),</span> 
            <span class="s2">&quot;Iterative Imputation (RandomForest)&quot;</span><span class="p">:</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">RandomForestRegressor</span><span class="p">()),</span>
            <span class="s2">&quot;Iterative Imputation (BayesianRidge)&quot;</span><span class="p">:</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">BayesianRidge</span><span class="p">()),</span>
            <span class="s2">&quot;SoftImpute&quot;</span><span class="p">:</span> <span class="n">SoftImpute</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;Matrix Factorization&quot;</span><span class="p">:</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
           <span class="p">}</span>

<span class="nd">@ignore_warnings</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">ConvergenceWarning</span><span class="p">)</span>
<span class="nd">@ignore_warnings</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_imputation</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">missing_iris</span><span class="p">()</span>
    <span class="n">imputed_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">X_imp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">imp</span> <span class="o">=</span> <span class="n">imputers</span><span class="p">[</span><span class="n">imputer</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">KNNImputer</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">IterativeImputer</span><span class="p">):</span>
        <span class="n">X_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">imp_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SimpleImputer</span><span class="p">(),</span> <span class="n">imp</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">())</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">imp_pipe</span><span class="p">,</span> <span class="n">X_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">X_imp</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">X_imp</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (ACC:</span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imputer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_imp</span><span class="p">[</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">X_imp</span><span class="p">[</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">imputed_mask</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;brg&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_imp</span><span class="p">[</span><span class="o">~</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">X_imp</span><span class="p">[</span><span class="o">~</span><span class="n">imputed_mask</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">imputed_mask</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;brg&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">)</span>
    <span class="c1"># this is for creating the legend...</span>
    <span class="n">square</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Imputed data&#39;</span><span class="p">)</span>
    <span class="n">circle</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">((</span><span class="mi">0</span><span class="p">,),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Real data&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">square</span><span class="p">,</span> <span class="n">circle</span><span class="p">],</span> <span class="n">numpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Mean/constant imputation</p></li>
<li><p>kNN-based imputation</p></li>
<li><p>Iterative (model-based) imputation</p></li>
<li><p>Matrix Factorization techniques</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ipywidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interact_manual</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">fetch_openml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">LabelEncoder</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_val_score</span>

<span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_imputers</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputer</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cc495256b51e4b8999d95746551cac3c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;kNN Imputation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="mean-imputation">
<h3>Mean imputation<a class="headerlink" href="#mean-imputation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Replace all missing values of a feature by the same value</p>
<ul>
<li><p>Numerical features: mean or median</p></li>
<li><p>Categorical features: most frequent category</p></li>
<li><p>Constant value, e.g. 0 or ‘missing’ for text features</p></li>
</ul>
</li>
<li><p>Optional: add an indicator column for missingness</p></li>
<li><p>Example: Iris dataset (randomly removed values in 3rd and 4th column)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Mean Imputation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/86795d1d0bb6d754db79777d74ec522a4a09f5461883cdd74183d7996cfb3674.png" src="../_images/86795d1d0bb6d754db79777d74ec522a4a09f5461883cdd74183d7996cfb3674.png" />
</div>
</div>
</section>
<section id="knn-imputation">
<h3>kNN imputation<a class="headerlink" href="#knn-imputation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Use special version of kNN to predict value of missing points</p></li>
<li><p>Uses only non-missing data when computing distances</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;kNN Imputation&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/70b5bbfc1f361e1ed6ed9ddb4c2d63d84e88f38d37119718fad3a8a84358c8cc.png" src="../_images/70b5bbfc1f361e1ed6ed9ddb4c2d63d84e88f38d37119718fad3a8a84358c8cc.png" />
</div>
</div>
</section>
<section id="iterative-model-based-imputation">
<h3>Iterative (model-based) Imputation<a class="headerlink" href="#iterative-model-based-imputation" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Better known as Multiple Imputation by Chained Equations (MICE)</p></li>
<li><p>Iterative approach</p>
<ul>
<li><p>Do first imputation (e.g. mean imputation)</p></li>
<li><p>Train model (e.g. RandomForest) to predict missing values of a given feature</p></li>
<li><p>Train new model on imputed data to predict missing values of the next feature</p>
<ul>
<li><p>Repeat <span class="math notranslate nohighlight">\(m\)</span> times in round-robin fashion, leave one feature out at a time</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Iterative Imputation (RandomForest)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e8dda1a37413d4bccbf3e9658dcb6a5c978dfd4e23c354362916e08aaeddc7d0.png" src="../_images/e8dda1a37413d4bccbf3e9658dcb6a5c978dfd4e23c354362916e08aaeddc7d0.png" />
</div>
</div>
</section>
<section id="matrix-factorization">
<h3>Matrix Factorization<a class="headerlink" href="#matrix-factorization" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Basic idea: low-rank approximation</p>
<ul>
<li><p>Replace missing values by 0</p></li>
<li><p>Factorize <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> with rank <span class="math notranslate nohighlight">\(r\)</span>: <span class="math notranslate nohighlight">\(\mathbf{X}^{n\times p}=\mathbf{U}^{n\times r} \mathbf{V}^{r\times p}\)</span></p>
<ul>
<li><p>With n data points and p features</p></li>
<li><p>Solved using gradient descent</p></li>
</ul>
</li>
<li><p>Recompute <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>: now complete</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Matrix Factorization&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/77965b1f7b12f3c0d02c8d5604f10140cff0c16e57485b27143c8dc1040dee48.png" src="../_images/77965b1f7b12f3c0d02c8d5604f10140cff0c16e57485b27143c8dc1040dee48.png" />
</div>
</div>
</section>
<section id="soft-thresholded-singular-value-decomposition-svd">
<h3>Soft-thresholded Singular Value Decomposition (SVD)<a class="headerlink" href="#soft-thresholded-singular-value-decomposition-svd" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Same basic idea, but smoother</p>
<ul>
<li><p>Replace missing values by 0, compute SVD: <span class="math notranslate nohighlight">\(\mathbf{X}=\mathbf{U} \mathbf{\Sigma} \mathbf{V^{T}}\)</span></p>
<ul>
<li><p>Solved with gradient descent</p></li>
</ul>
</li>
<li><p>Reduce eigenvalues by shrinkage factor: <span class="math notranslate nohighlight">\(\lambda_i = s\cdot\lambda_i\)</span></p></li>
<li><p>Recompute <span class="math notranslate nohighlight">\(\mathbf{X}\)</span>: now complete</p></li>
<li><p>Repeat for <span class="math notranslate nohighlight">\(m\)</span> iterations</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;SoftImpute&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/cdfa95c6abb2e78b0525835cb5f3004b7da922bb60e81fd33830ac4a7fd47d19.png" src="../_images/cdfa95c6abb2e78b0525835cb5f3004b7da922bb60e81fd33830ac4a7fd47d19.png" />
</div>
</div>
</section>
<section id="id3">
<h3>Comparison<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Best method depends on the problem and dataset at hand. Use cross-validation.</p></li>
<li><p>Iterative Imputation (MICE) generally works well for missing (completely) at random data</p>
<ul>
<li><p>Can be slow if the prediction model is slow</p></li>
</ul>
</li>
<li><p>Low-rank approximation techniques scale well to large datasets</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_imputers</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="n">imputer</span><span class="o">=</span><span class="n">imputer</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3f63cc82a7cf40e7b85b426ceaabff14", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_imputation</span><span class="p">(</span><span class="s2">&quot;Iterative Imputation (RandomForest)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="id4">
<h3>In practice (scikit-learn)<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Simple replacement: <code class="docutils literal notranslate"><span class="pre">SimpleImputer</span></code></p>
<ul>
<li><p>Strategies: <code class="docutils literal notranslate"><span class="pre">mean</span></code> (numeric), <code class="docutils literal notranslate"><span class="pre">median</span></code>, <code class="docutils literal notranslate"><span class="pre">most_frequent</span></code> (categorical)</p></li>
<li><p>Choose whether to add indicator columns, and how missing values are encoded</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">missing_values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">add_indicator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>kNN Imputation: <code class="docutils literal notranslate"><span class="pre">KNNImputer</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">KNNImputer</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Multiple Imputation (MICE): <code class="docutils literal notranslate"><span class="pre">IterativeImputer</span></code></p>
<ul>
<li><p>Choose estimator (default: <code class="docutils literal notranslate"><span class="pre">BayesianRidge</span></code>) and number of iterations (default 10)</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">RandomForestClassifier</span><span class="p">(),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="in-practice-fancyimpute">
<h3>In practice (fancyimpute)<a class="headerlink" href="#in-practice-fancyimpute" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Cannot be used in CV pipelines (has <code class="docutils literal notranslate"><span class="pre">fit_transform</span></code> but no <code class="docutils literal notranslate"><span class="pre">transform</span></code>)</p></li>
<li><p>Soft-Thresholded SVD: <code class="docutils literal notranslate"><span class="pre">SoftImpute</span></code></p>
<ul>
<li><p>Choose max number of gradient descent iterations</p></li>
<li><p>Choose shrinkage value for eigenvectors (default: <span class="math notranslate nohighlight">\(\frac{1}{N}\)</span>)</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">SoftImpute</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shrinkage_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Low-rank imputation: <code class="docutils literal notranslate"><span class="pre">MatrixFactorization</span></code></p>
<ul>
<li><p>Choose rank of the low-rank approximation</p></li>
<li><p>Gradient descent hyperparameters: learning rate, epochs,…</p></li>
<li><p>Several variants exist</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imp</span> <span class="o">=</span> <span class="n">MatrixFactorization</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">X_complete</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="handling-imbalanced-data">
<h2>Handling imbalanced data<a class="headerlink" href="#handling-imbalanced-data" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Problem:</p>
<ul>
<li><p>You have a majority class with many times the number of examples as the minority class</p></li>
<li><p>Or: classes are balanced, but associated costs are not (e.g. FN are worse than FP)</p></li>
</ul>
</li>
<li><p>We already covered some ways to resolve this:</p>
<ul>
<li><p>Add class weights to the loss function: give the minority class more weight</p>
<ul>
<li><p>In practice: set <code class="docutils literal notranslate"><span class="pre">class_weight='balanced'</span></code></p></li>
</ul>
</li>
<li><p>Change the prediction threshold to minimize false negatives or false positives</p></li>
</ul>
</li>
<li><p>There are also things we can do by preprocessing the data</p>
<ul>
<li><p>Resample the data to correct the imbalance</p>
<ul>
<li><p>Random or model-based</p></li>
</ul>
</li>
<li><p>Generate synthetic samples for the minority class</p></li>
<li><p>Build ensembles over different resampled datasets</p></li>
<li><p>Combinations of these</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.over_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomOverSampler</span><span class="p">,</span> <span class="n">SMOTE</span><span class="p">,</span> <span class="n">ADASYN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.under_sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomUnderSampler</span><span class="p">,</span> <span class="n">EditedNearestNeighbours</span><span class="p">,</span> <span class="n">CondensedNearestNeighbour</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">EasyEnsembleClassifier</span><span class="p">,</span> <span class="n">BalancedBaggingClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.combine</span><span class="w"> </span><span class="kn">import</span> <span class="n">SMOTEENN</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">imblearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pipeline</span> <span class="k">as</span> <span class="n">make_imb_pipeline</span> <span class="c1"># avoid confusion</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">shuffle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">cross_validate</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.svm</span><span class="w"> </span><span class="kn">import</span> <span class="n">SVC</span>

<span class="c1"># Some imbalanced data</span>
<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">n_samples_1</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">n_samples_2</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">X_syn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples_1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">rng</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n_samples_2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="n">y_syn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_samples_1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_samples_2</span><span class="p">))</span>
<span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
<span class="n">X_syn_train</span><span class="p">,</span> <span class="n">X_syn_test</span><span class="p">,</span> <span class="n">y_syn_train</span><span class="p">,</span> <span class="n">y_syn_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
<span class="n">X0min</span><span class="p">,</span> <span class="n">X0max</span><span class="p">,</span> <span class="n">X1min</span><span class="p">,</span> <span class="n">X1max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

<span class="c1">#samplers = [RandomUnderSampler(),EditedNearestNeighbours(),CondensedNearestNeighbour(),RandomOverSampler(),</span>
<span class="c1">#           SMOTE(), ADASYN(), EasyEnsembleClassifier(), BalancedBaggingClassifier(), SMOTEENN()]</span>
<span class="n">samplers</span> <span class="o">=</span> <span class="p">[</span><span class="n">RandomUnderSampler</span><span class="p">(),</span><span class="n">EditedNearestNeighbours</span><span class="p">(),</span><span class="n">RandomOverSampler</span><span class="p">(),</span>
           <span class="n">SMOTE</span><span class="p">(),</span> <span class="n">ADASYN</span><span class="p">(),</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(),</span> <span class="n">BalancedBaggingClassifier</span><span class="p">(),</span> <span class="n">SMOTEENN</span><span class="p">()]</span>
<span class="n">learners</span> <span class="o">=</span> <span class="p">[</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">SVC</span><span class="p">(),</span> <span class="n">RandomForestClassifier</span><span class="p">()]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_imbalance</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="n">RandomUnderSampler</span><span class="p">(),</span> <span class="n">sampler2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="n">LogisticRegression</span><span class="p">()):</span>
    
    <span class="c1"># Appends multiple undersamplings for plotting purposes</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_bagging</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">):</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">X_resampled_i</span><span class="p">,</span> <span class="n">y_resampled_i</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
            <span class="n">X_resampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">,</span><span class="n">X_resampled_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">,</span><span class="n">y_resampled_i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">build_evaluate</span><span class="p">(</span><span class="n">sampler</span><span class="p">):</span>
        <span class="c1"># Build new data</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">EasyEnsembleClassifier</span><span class="p">):</span>
            <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">simulate_bagging</span><span class="p">(</span><span class="n">RandomUnderSampler</span><span class="p">(),</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">BalancedBaggingClassifier</span><span class="p">):</span>
            <span class="n">balancer</span> <span class="o">=</span> <span class="n">RandomUnderSampler</span><span class="p">(</span><span class="n">sampling_strategy</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">simulate_bagging</span><span class="p">(</span><span class="n">balancer</span><span class="p">,</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">fit_resample</span><span class="p">(</span><span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">)</span>

        <span class="c1"># Evaluate</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">EasyEnsembleClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">BalancedBaggingClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">BalancedBaggingClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">)[</span><span class="s1">&#39;test_score&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scores</span>
    
    <span class="n">orig_scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">LogisticRegression</span><span class="p">(),</span> <span class="n">X_syn</span><span class="p">,</span> <span class="n">y_syn</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">)[</span><span class="s1">&#39;test_score&#39;</span><span class="p">]</span>
        
    <span class="c1"># Plot</span>
    <span class="n">nr_plots</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">sampler2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">3</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">nr_plots</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;xticks&#39;</span><span class="p">:(),</span> <span class="s1">&#39;yticks&#39;</span><span class="p">:()})</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original (AUC: </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">orig_scores</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_syn</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_syn</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">y_syn</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
 
    <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">build_evaluate</span><span class="p">(</span><span class="n">sampler</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (AUC: </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sampler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">X0min</span><span class="p">,</span> <span class="n">X0max</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">X1min</span><span class="p">,</span> <span class="n">X1max</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">sampler2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="n">build_evaluate</span><span class="p">(</span><span class="n">sampler2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (AUC: </span><span class="si">{:.3f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sampler2</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X_resampled</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="p">(</span><span class="n">y_resampled</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">X0min</span><span class="p">,</span> <span class="n">X0max</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="n">X1min</span><span class="p">,</span> <span class="n">X1max</span><span class="p">))</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="random-undersampling">
<h3>Random Undersampling<a class="headerlink" href="#random-undersampling" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Copy the points from the minority class</p></li>
<li><p>Randomly sample from the majority class (with or without replacement) until balanced</p>
<ul>
<li><p>Optionally, sample until a certain imbalance ratio (e.g. 1/5) is reached</p></li>
<li><p>Multi-class: repeat with every other class</p></li>
</ul>
</li>
<li><p>Preferred for large datasets, often yields smaller/faster models with similar performance</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">RandomUnderSampler</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/11f960b5052428dfe0b8aacdba41672524e2e9b7e3204145dc9e41797b0a4f2e.png" src="../_images/11f960b5052428dfe0b8aacdba41672524e2e9b7e3204145dc9e41797b0a4f2e.png" />
</div>
</div>
</section>
<section id="model-based-undersampling">
<h3>Model-based Undersampling<a class="headerlink" href="#model-based-undersampling" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Edited Nearest Neighbors</p>
<ul>
<li><p>Remove all majority samples that are misclassified by kNN (mode) or that have a neighbor from the other class (all).</p></li>
<li><p>Remove their influence on the minority samples</p></li>
</ul>
</li>
<li><p>Condensed Nearest Neighbors</p>
<ul>
<li><p>Remove all majority samples that are <em>not</em> misclassified by kNN</p></li>
<li><p>Focus on only the hard samples</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">EditedNearestNeighbours</span><span class="p">(),</span> <span class="n">CondensedNearestNeighbour</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/14fe8387ae69f432286d240b5bb1f83fd4fb317133aa0b5ae4266eb404bf24af.png" src="../_images/14fe8387ae69f432286d240b5bb1f83fd4fb317133aa0b5ae4266eb404bf24af.png" />
</div>
</div>
</section>
<section id="random-oversampling">
<h3>Random Oversampling<a class="headerlink" href="#random-oversampling" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Copy the points from the majority class</p></li>
<li><p>Randomly sample from the minority class, with replacement, until balanced</p>
<ul>
<li><p>Optionally, sample until a certain imbalance ratio (e.g. 1/5) is reached</p></li>
</ul>
</li>
<li><p>Makes models more expensive to train, doens’t always improve performance</p></li>
<li><p>Similar to giving minority class(es) a higher weight (and more expensive)</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">RandomOverSampler</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/77333c37b5e69b97a38356ad048638ca2fe2ad29e00836cb8ea2d0c874588c47.png" src="../_images/77333c37b5e69b97a38356ad048638ca2fe2ad29e00836cb8ea2d0c874588c47.png" />
</div>
</div>
</section>
<section id="synthetic-minority-oversampling-technique-smote">
<h3>Synthetic Minority Oversampling Technique (SMOTE)<a class="headerlink" href="#synthetic-minority-oversampling-technique-smote" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Repeatedly choose a random minority point and a neighboring minority point</p>
<ul>
<li><p>Pick a new, artificial point on the line between them (uniformly)</p></li>
</ul>
</li>
<li><p>May bias the data. Be careful never to create artificial points in the test set.</p></li>
<li><p>ADASYN (Adaptive Synthetic)</p>
<ul>
<li><p>Similar, but starts from ‘hard’ minority points (misclassified by kNN)</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">SMOTE</span><span class="p">(),</span> <span class="n">ADASYN</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/ba2c5e4ced7abfe6c4da6342d3c680bda910586020a0f528902a7ad1f4fc54fc.png" src="../_images/ba2c5e4ced7abfe6c4da6342d3c680bda910586020a0f528902a7ad1f4fc54fc.png" />
</div>
</div>
</section>
<section id="combined-techniques">
<h3>Combined techniques<a class="headerlink" href="#combined-techniques" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Combines over- and under-sampling</p></li>
<li><p>E.g. oversampling with SMOTE, undersampling with Edited Nearest Neighbors (ENN)</p>
<ul>
<li><p>SMOTE can generate ‘noisy’ point, close to majority class points</p></li>
<li><p>ENN will remove up these majority points to ‘clean up’ the space</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">SMOTEENN</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/2805e70b82c585b5110bcc93cb8ce6da3d176e1bb83b5b462881391ec7c3091b.png" src="../_images/2805e70b82c585b5110bcc93cb8ce6da3d176e1bb83b5b462881391ec7c3091b.png" />
</div>
</div>
</section>
<section id="ensemble-resampling">
<h3>Ensemble Resampling<a class="headerlink" href="#ensemble-resampling" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Bagged ensemble of balanced base learners. Acts as a learner, not a preprocessor</p></li>
<li><p>BalancedBagging: take bootstraps, randomly undersample each, train models (e.g. trees)</p>
<ul>
<li><p>Benefits of random undersampling without throwing out so much data</p></li>
</ul>
</li>
<li><p>Easy Ensemble: take multiple random undersamplings directly, train models</p>
<ul>
<li><p>Traditionally uses AdaBoost as base learner, but can be replaced</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_imbalance</span><span class="p">(</span><span class="n">EasyEnsembleClassifier</span><span class="p">(),</span> <span class="n">BalancedBaggingClassifier</span><span class="p">())</span> 
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/0aa64ce2e248bbb8c952fb5bc9ebf53d570605597a26f091267164a8c079e37f.png" src="../_images/0aa64ce2e248bbb8c952fb5bc9ebf53d570605597a26f091267164a8c079e37f.png" />
</div>
</div>
</section>
<section id="id5">
<h3>Comparison<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The best method depends on the data (amount of data, imbalance,…)</p>
<ul>
<li><p>For a very large dataset, random undersampling may be fine</p></li>
</ul>
</li>
<li><p>You still need to choose the appropriate learning algorithms</p></li>
<li><p>Don’t forget about class weighting and prediction thresholding</p>
<ul>
<li><p>Some combinations are useful, e.g. SMOTE + class weighting + thresholding</p></li>
</ul>
</li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compare_imbalance</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="n">samplers</span><span class="p">,</span> <span class="n">learner</span><span class="o">=</span><span class="n">learners</span><span class="p">):</span>
    <span class="n">plot_imbalance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "37b78d8cf1254213917dbd9ed61d41f4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">plot_imbalance</span><span class="p">(</span><span class="n">EasyEnsembleClassifier</span><span class="p">())</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="in-practice-imblearn">
<h3>In practice (<a class="reference external" href="http://imbalanced-learn.org">imblearn</a>)<a class="headerlink" href="#in-practice-imblearn" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Follows fit-sample paradigm (equivalent of fit-transform, but also affects y)</p></li>
<li><p>Undersampling: RandomUnderSampler, EditedNearestNeighbours,…</p></li>
<li><p>(Synthetic) Oversampling: RandomOverSampler, SMOTE, ADASYN,…</p></li>
<li><p>Combinations: SMOTEENN,…</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">X_resampled</span><span class="p">,</span> <span class="n">y_resampled</span> <span class="o">=</span> <span class="n">SMOTE</span><span class="p">(</span><span class="n">k_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit_sample</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Can be used in imblearn pipelines (not sklearn pipelines)</p>
<ul>
<li><p>imblearn pipelines are compatible with GridSearchCV,…</p></li>
<li><p>Sampling is only done in <code class="docutils literal notranslate"><span class="pre">fit</span></code> (not in <code class="docutils literal notranslate"><span class="pre">predict</span></code>)</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">smote_pipe</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">SMOTE</span><span class="p">(),</span> <span class="n">LogisticRegression</span><span class="p">())</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_validate</span><span class="p">(</span><span class="n">smote_pipe</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k_neighbors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]}</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">smote_pipe</span><span class="p">,</span> <span class="n">param_grid</span><span class="o">=</span><span class="n">param_grid</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The ensembling techniques should be used as wrappers</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">clf</span> <span class="o">=</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">SVC</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="real-world-data">
<h3>Real-world data<a class="headerlink" href="#real-world-data" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>The effect of sampling procedures can be unpredictable</p></li>
<li><p>Best method can depend on the data and FP/FN trade-offs</p></li>
<li><p>SMOTE and ensembling techniques often work well</p></li>
</ul>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">precision_recall_curve</span>

<span class="c1"># Datasets</span>
<span class="c1"># Try more if you like: [&#39;Speech&#39; ,&#39;mc1&#39;,&#39;mammography&#39;]</span>
<span class="c1"># Only showing Speech by default to speed up compute</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Speech&#39;</span><span class="p">,</span><span class="s1">&#39;mc1&#39;</span><span class="p">,</span><span class="s1">&#39;mammography&#39;</span><span class="p">]</span> 
    
<span class="n">roc_curves</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span> <span class="n">dataset</span><span class="p">)</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Get data</span>
    <span class="n">data_imb</span> <span class="o">=</span> <span class="n">fetch_openml</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="n">X_imb</span><span class="p">,</span> <span class="n">y_imb</span> <span class="o">=</span> <span class="n">data_imb</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data_imb</span><span class="o">.</span><span class="n">target</span>
    <span class="n">y_imb</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">y_imb</span><span class="p">)</span>
    <span class="n">X_imb_train</span><span class="p">,</span> <span class="n">X_imb_test</span><span class="p">,</span> <span class="n">y_imb_train</span><span class="p">,</span> <span class="n">y_imb_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_imb</span><span class="p">,</span> <span class="n">y_imb</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y_imb</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Original data</span>
    <span class="n">rf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_imb_train</span><span class="p">,</span> <span class="n">y_imb_train</span><span class="p">)</span>
    <span class="n">probs_original</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_imb_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr_org</span><span class="p">,</span> <span class="n">tpr_org</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs_original</span><span class="p">)</span>
    <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs_original</span><span class="p">)</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;fpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr_org</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;tpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpr_org</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>
    <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall</span>

    <span class="c1"># Corrected data</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sampler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">samplers</span><span class="p">):</span>
        <span class="n">sname</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Evaluating&quot;</span><span class="p">,</span> <span class="n">sname</span><span class="p">)</span>
        <span class="c1"># Evaluate</span>
        <span class="n">learner</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">EasyEnsembleClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">EasyEnsembleClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span><span class="n">BalancedBaggingClassifier</span><span class="p">):</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">BalancedBaggingClassifier</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">learner</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipe</span> <span class="o">=</span> <span class="n">make_imb_pipeline</span><span class="p">(</span><span class="n">sampler</span><span class="p">,</span> <span class="n">learner</span><span class="p">)</span>

        <span class="n">pipe</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_imb_train</span><span class="p">,</span> <span class="n">y_imb_train</span><span class="p">)</span>
        <span class="n">probs</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_imb_test</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_imb_test</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;fpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpr</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;tpr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tpr</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;precision&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">sname</span><span class="p">][</span><span class="s2">&quot;recall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recall</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset Speech
Evaluating RandomUnderSampler
Evaluating EditedNearestNeighbours
Evaluating RandomOverSampler
Evaluating SMOTE
Evaluating ADASYN
Evaluating EasyEnsembleClassifier
Evaluating BalancedBaggingClassifier
Evaluating SMOTEENN
Dataset mc1
Evaluating RandomUnderSampler
Evaluating EditedNearestNeighbours
Evaluating RandomOverSampler
Evaluating SMOTE
Evaluating ADASYN
Evaluating EasyEnsembleClassifier
Evaluating BalancedBaggingClassifier
Evaluating SMOTEENN
Dataset mammography
Evaluating RandomUnderSampler
Evaluating EditedNearestNeighbours
Evaluating RandomOverSampler
Evaluating SMOTE
Evaluating ADASYN
Evaluating EasyEnsembleClassifier
Evaluating BalancedBaggingClassifier
Evaluating SMOTEENN
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Colors for 9 methods</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;hsv&#39;</span><span class="p">)</span>
<span class="n">roccol</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">roccol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">i</span><span class="o">/</span><span class="mi">9</span><span class="p">))</span>
    
<span class="n">curves</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ROC&#39;</span><span class="p">,</span><span class="s1">&#39;Precision-Recall&#39;</span><span class="p">]</span>

<span class="nd">@interact</span>
<span class="k">def</span><span class="w"> </span><span class="nf">roc_imbalance</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="n">curves</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">fig_scale</span><span class="p">))</span>

    <span class="c1"># Add to plot</span>
    <span class="n">curvy</span> <span class="o">=</span> <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="s2">&quot;original&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">curve</span> <span class="o">==</span> <span class="s1">&#39;ROC&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;fpr&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;tpr&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;original&quot;</span><span class="p">:</span>
            <span class="n">curvy</span> <span class="o">=</span> <span class="n">roc_curves</span><span class="p">[</span><span class="n">dataset</span><span class="p">][</span><span class="n">method</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">curve</span> <span class="o">==</span> <span class="s1">&#39;ROC&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;fpr&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;tpr&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">roccol</span><span class="p">[</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">roccol</span><span class="p">[</span><span class="n">curvy</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">curve</span> <span class="o">==</span> <span class="s1">&#39;ROC&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RandomForest ROC curve on </span><span class="si">{}</span><span class="s2"> dataset&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Recall&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Precision&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RandomForest PR curve on </span><span class="si">{}</span><span class="s2"> dataset&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "8729ab8bb3e84fc9a5192a0a76c2a1bb", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">interactive</span><span class="p">:</span>
    <span class="n">roc_imbalance</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;Speech&#39;</span><span class="p">,</span> <span class="n">curve</span><span class="o">=</span><span class="s1">&#39;ROC&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Data preprocessing is a crucial part of machine learning</p>
<ul>
<li><p>Scaling is important for many distance-based methods (e.g. kNN, SVM, Neural Nets)</p></li>
<li><p>Categorical encoding is necessary for numeric methods (or implementations)</p></li>
<li><p>Selecting features can speed up models and reduce overfitting</p></li>
<li><p>Feature engineering is often useful for linear models</p></li>
<li><p>It is often better to impute missing data than to remove data</p></li>
<li><p>Imbalanced datasets require extra care to build useful models</p></li>
</ul>
</li>
<li><p>Pipelines allow us to encapsulate multiple steps in a convenient way</p>
<ul>
<li><p>Avoids data leakage, crucial for proper evaluation</p></li>
</ul>
</li>
<li><p>Choose the right preprocessing steps and models in your pipeline</p>
<ul>
<li><p>Cross-validation helps, but the search space is huge</p></li>
<li><p>Smarter techniques exist to automate this process (AutoML)</p></li>
</ul>
</li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="04%20-%20Ensemble%20Learning.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lecture 4. Ensemble Learning</p>
      </div>
    </a>
    <a class="right-next"
       href="06%20-%20Neural%20Networks.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Lecture 6. Neural Networks</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-transformations">Data transformations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scaling">Scaling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#power-transformations">Power transformations</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#categorical-feature-encoding">Categorical feature encoding</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ordinal-encoding">Ordinal encoding</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#one-hot-encoding-dummy-encoding">One-hot encoding (dummy encoding)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#target-encoding">Target encoding</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-category-encoders">Example (category_encoders)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-practice-scikit-learn">In practice (scikit-learn)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#applying-data-transformations">Applying data transformations</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#test-set-distortion">Test set distortion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-leakage">Data leakage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#data-processing-pipelines">Data processing pipelines</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">In practice (scikit-learn)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automatic-feature-selection">Automatic Feature Selection</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-bike-sharing">Example: bike sharing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#feature-selection-overview">Feature selection: overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-based-feature-selection">Model-based Feature Selection</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#relief-model-based-selection-with-knn">Relief: Model-based selection with kNN</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-model-based-feature-selection">Iterative Model-based Feature Selection</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sequential-feature-selection-wrapping">Sequential feature selection (Wrapping)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#permutation-feature-importance">Permutation feature importance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#comparison">Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">In practice (scikit-learn)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#missing-value-imputation">Missing value imputation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mean-imputation">Mean imputation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#knn-imputation">kNN imputation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterative-model-based-imputation">Iterative (model-based) Imputation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#matrix-factorization">Matrix Factorization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#soft-thresholded-singular-value-decomposition-svd">Soft-thresholded Singular Value Decomposition (SVD)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">In practice (scikit-learn)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-practice-fancyimpute">In practice (fancyimpute)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#handling-imbalanced-data">Handling imbalanced data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-undersampling">Random Undersampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-based-undersampling">Model-based Undersampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#random-oversampling">Random Oversampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-minority-oversampling-technique-smote">Synthetic Minority Oversampling Technique (SMOTE)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combined-techniques">Combined techniques</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ensemble-resampling">Ensemble Resampling</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Comparison</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-practice-imblearn">In practice (imblearn)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#real-world-data">Real-world data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Joaquin Vanschoren
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025. CC0 Licensed - Use as you like. Appropriate credit is very welcome.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>